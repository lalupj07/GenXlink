name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build and test
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --all

      - name: Build release
        run: cargo build --release --package genxlink-server

  # Deploy to Railway (if secrets are configured)
  deploy-railway:
    name: Deploy to Railway
    needs: build
    runs-on: ubuntu-latest
    # Only run if RAILWAY_TOKEN secret is set
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Railway Token
        id: check-railway
        run: |
          # Note: secrets.RAILWAY_TOKEN is a valid GitHub Actions context
          # IDE warnings about this are false positives
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "Railway token not configured, skipping deployment"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Railway CLI
        if: steps.check-railway.outputs.skip != 'true'
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        if: steps.check-railway.outputs.skip != 'true'
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          railway up --service genxlink-api || echo "Railway deployment skipped"
          railway up --service genxlink-signaling || echo "Railway deployment skipped"
          railway up --service genxlink-relay || echo "Railway deployment skipped"

  # Deploy to Fly.io (if secrets are configured)
  deploy-fly:
    name: Deploy to Fly.io
    needs: build
    runs-on: ubuntu-latest
    # Only run on main branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Fly Token
        id: check-fly
        run: |
          # Note: secrets.FLY_API_TOKEN is a valid GitHub Actions context
          # IDE warnings about this are false positives
          if [ -z "${{ secrets.FLY_API_TOKEN }}" ]; then
            echo "Fly.io token not configured, skipping deployment"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Flyctl
        if: steps.check-fly.outputs.skip != 'true'
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        if: steps.check-fly.outputs.skip != 'true'
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --config fly.toml || echo "Fly.io deployment skipped"

  # Notification job
  notify:
    name: Notify Deployment Status
    needs: [build, deploy-railway, deploy-fly]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "Deployment completed!"
          echo "Build status: ${{ needs.build.result }}"
          echo "Railway deployment: ${{ needs.deploy-railway.result }}"
          echo "Fly.io deployment: ${{ needs.deploy-fly.result }}"
